@page "/"

@using Microsoft.Extensions.Configuration
@using portfolio_admin.Services
@inject JsonRepository JsonRepo
@inject GitService GitService

<div class="toolbar mb-3 bg-white shadow-sm p-3 rounded d-flex justify-content-between align-items-center flex-wrap">
    <div class="d-flex flex-column">
        <div class="fw-bold">
            @Repo <span class="text-muted">(@Branch)</span>
        </div>
        <div class="text-muted small">@statusMessage</div>
    </div>

    <div class="mt-2 mt-sm-0">
        <button class="base-button me-2 px-4 py-1" @onclick="PullRepo">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-down me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1 3.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5M8 6a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 .708-.708L7.5 12.293V6.5A.5.5 0 0 1 8 6" />
            </svg>

            Pull
        </button>
        <button class="base-button px-4 py-1" data-bs-toggle="modal" data-bs-target="#commitModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-up me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5m-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5" />
            </svg>

            Commit & Push
        </button>
    </div>
</div>


<div class="d-flex" style="height:70vh;">
    <div class="file-list border-end pe-3 bg-white shadow-sm rounded p-3" style="width: 30%; overflow-y:auto;">
        <h6 class="mb-4">JSON fájlok</h6>

        @if (files == null)
        {
            <p><em>Betöltés...</em></p>
        }
        else
        {
            <ul class="list-group">
                @foreach (var f in files)
                {
                    <li class="list-group-item mb-2 border rounded @(selectedFile == f ? "bg-selected" : "")">
                        <div class="file-item d-flex justify-content-between align-items-center
                                                                                                        @(selectedFile == f ? "fw-bold text-primary" : "")"
                             style="cursor:pointer;">
                            <span @onclick="() => SelectFile(f)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-binary mb-1 me-1" viewBox="0 0 16 16">
                                    <path d="M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z" />
                                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                                </svg>

                                @f
                            </span>
                            <span class="btn btn-sm py-2 px-1"
                                  title="Törlés"
                                  @onclick="() => DeleteFile(f)">

                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                    <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                </svg>
                            </span>
                        </div>
                    </li>
                }
            </ul>

            <div class="mt-3">
                <input type="text" class="form-control form-control-sm" placeholder="Új fájl neve" @bind="newFileName" />
                <button class=" mt-1 px-4 py-1 form-control base-button" @onclick="CreateFile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                    </svg>
                </button>
            </div>
        }
    </div>

    <div class="editor flex-grow-1 ps-3 bg-white shadow-sm rounded p-3 ms-3">
        @if (selectedFile == null)
        {
            <p class="text-muted">Válassz egy JSON fájlt a szerkesztéshez.</p>
        }
        else
        {
            <h6 class="mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-binary mb-1 me-1" viewBox="0 0 16 16">
                    <path d="M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z" />
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                </svg>

                @selectedFile
            </h6>
            <textarea class="form-control font-monospace mb-3" style="height:53vh; resize: none;" @bind="fileContent"></textarea>
            <div class="mt-2">
                <button class="base-button me-2 px-4 py-1" @onclick="FormatJson">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-code-slash me-1 mb-1" viewBox="0 0 16 16">
                        <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0m6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0" />
                    </svg>

                    Formázás
                </button>
                <button class="base-button px-4 py-1" @onclick="SaveFile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy me-1 mb-1" viewBox="0 0 16 16">
                        <path d="M11 2H9v3h2z" />
                        <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z" />
                    </svg>

                    Mentés
                </button>
            </div>
        }
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="commitModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title fs-5" id="exampleModalLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-diagram-3 me-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H14a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 2 7h5.5V6A1.5 1.5 0 0 1 6 4.5zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5zM0 11.5A1.5 1.5 0 0 1 1.5 10h1A1.5 1.5 0 0 1 4 11.5v1A1.5 1.5 0 0 1 2.5 14h-1A1.5 1.5 0 0 1 0 12.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm4.5.5A1.5 1.5 0 0 1 7.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1A1.5 1.5 0 0 1 8.5 14h-1A1.5 1.5 0 0 1 6 12.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1a1.5 1.5 0 0 1-1.5-1.5zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z" />
                    </svg>

                    Commit & Push
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-secondary"> Add meg a commit üzenetet a változtatásaidhoz. </p>
                <textarea class="form-control" placeholder="Commit üzenet..." @bind="commitMessage"></textarea>
            </div>
            <div class="modal-footer">
                <button class="base-button-inverse px-4 py-1" data-bs-dismiss="modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg mb-1 me-1" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z" />
                    </svg>

                    Mégse
                </button>
                <button class="base-button px-4 py-1" @onclick="CommitAndPush" data-bs-dismiss="modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-plus me-1 mb-1" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855a.75.75 0 0 0-.124 1.329l4.995 3.178 1.531 2.406a.5.5 0 0 0 .844-.536L6.637 10.07l7.494-7.494-1.895 4.738a.5.5 0 1 0 .928.372zm-2.54 1.183L5.93 9.363 1.591 6.602z" />
                        <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-3.5-2a.5.5 0 0 0-.5.5v1h-1a.5.5 0 0 0 0 1h1v1a.5.5 0 0 0 1 0v-1h1a.5.5 0 0 0 0-1h-1v-1a.5.5 0 0 0-.5-.5" />
                    </svg>

                    Push
                </button>
            </div>
        </div>
    </div>
</div>



@code {
    [Inject] IConfiguration Config { get; set; } = default!;

    private string? Repo;
    private string? Branch;

    private List<string>? files;
    private string? selectedFile;
    private string? fileContent;
    private string? statusMessage;
    private string? newFileName;
    private string? commitMessage;

    protected override async Task OnInitializedAsync()
    {
        Repo = Config["DatabaseRepoLinkSSH"];
        Branch = Config["DatabaseRepoBranch"];
        await LoadFiles();
    }

    private async Task LoadFiles()
    {
        files = JsonRepo.GetJsonFiles().ToList();
    }

    private void SelectFile(string file)
    {
        if (file != null)
        {
            selectedFile = file;
            fileContent = JsonRepo.ReadFile(file);
            statusMessage = $"Megnyitva: {file}";
        }
    }

    private void CreateFile()
    {
        if (string.IsNullOrWhiteSpace(newFileName))
        {
            statusMessage = "Adj meg egy fájlnevet!";
            return;
        }

        JsonRepo.CreateFile(newFileName);
        LoadFiles();
        newFileName = "";
        statusMessage = "Új fájl létrehozva.";
        LoadFiles();
    }

    private void SaveFile()
    {
        if (selectedFile == null) return;
        JsonRepo.SaveFile(selectedFile, fileContent ?? "");
        statusMessage = $"Mentve: {selectedFile}";
    }

    private void DeleteFile(string filename)
    {
        try
        {
            JsonRepo.DeleteFile(filename);
            LoadFiles();
            if (selectedFile == filename)
            {
                selectedFile = null;
                fileContent = null;
            }
            statusMessage = $"Törölve: {filename}";
        }
        catch (Exception ex)
        {
            statusMessage = $"Törlés hiba: {ex.Message}";
        }
    }

    private void FormatJson()
    {
        try
        {
            var parsed = System.Text.Json.JsonDocument.Parse(fileContent ?? "{}");
            fileContent = System.Text.Json.JsonSerializer.Serialize(parsed, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            });
            statusMessage = "JSON formázva.";
        }
        catch
        {
            statusMessage = "Hibás JSON szintaxis!";
        }
    }

    private void PullRepo()
    {
        try
        {
            GitService.Pull();
            LoadFiles();
            statusMessage = "Repo frissítve (pull).";
        }
        catch (Exception ex)
        {
            statusMessage = $"Pull hiba: {ex.Message}";
        }
    }

    private void CommitAndPush()
    {
        try
        {
            GitService.CommitAndPush(commitMessage ?? "Update JSON files");
            statusMessage = "Változások feltöltve.";
        }
        catch (Exception ex)
        {
            statusMessage = $"Push hiba: {ex.Message}";
        }
    }
}
