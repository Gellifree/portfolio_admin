@page "/projects"
@using portfolio_admin.Models
@using portfolio_admin.Services
@inject JsonRepository Repo

<h3>Project list</h3>

@if (projects == null)
{
    <p> Loading project list. Please wait patiently. </p>
}
else
{
    <button @onclick="NewProject" class="portfolio-button py-2 px-3 mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
        </svg>

        <span class="ms-2"> Add project </span>
    </button>

    <ul class="list-group mb-3 mt-4">
        @foreach (var p in projects)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <b>@p.Title</b> – @p.Description
                </div>
                <div>
                    <button class="portfolio-button py-2 px-3 me-1" @onclick="() => EditProject(p)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                            <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001"/>
                        </svg>
                    </button>
                    <button class="portfolio-button py-2 px-3" @onclick="() => DeleteProject(p.Id)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                        </svg>
                    </button>
                </div>
            </li>
        }
    </ul>
}

@if (editingProject != null)
{
    <div class="card p-3 mb-3">
        <h5>@(isNew ? "Adding new Project" : "Editing selected Project")</h5>

        <div class="mb-2">
            <label class="form-label">Title:</label>
            <input class="form-control" @bind="editingProject.Title" />
        </div>
        <div class="mb-2">
            <label class="form-label">Description:</label>
            <input class="form-control" @bind="editingProject.Description" />
        </div>
        <div class="mb-2">
            <label class="form-label">Link:</label>
            <input class="form-control" @bind="editingProject.Link" />
        </div>
        <div class="mb-2">
            <label class="form-label">Image:</label>
            <input class="form-control" @bind="editingProject.Image" />
        </div>

        <button class="portfolio-button py-2 px-3 me-2" @onclick="SaveProject">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy-fill" viewBox="0 0 16 16">
                <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
                <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
            </svg>
            
            Save
        </button>
        <button class="portfolio-button py-2 px-3 mt-2" @onclick="CancelEdit">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
            </svg>

            Cancel
        </button>
    </div>
}

        @if (projects != null)
        {
            <div class="card p-3 mt-4 mt-5">
                <h5>Commit message for pushing</h5>
                <input class="form-control mb-2" placeholder="Commit message" @bind="commitMessage" />
                <button class="portfolio-button py-2 px-3" @onclick="CommitAndPush">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload-fill" viewBox="0 0 16 16">
                        <path d="M8 0a5.53 5.53 0 0 0-4.473 2.252 4.002 4.002 0 0 0-1.478 7.743A5.53 5.53 0 0 0 8 16a5.53 5.53 0 0 0 4.473-2.252 4.002 4.002 0 0 0 1.478-7.743A5.53 5.53 0 0 0 8 0m.5 5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 9.293V5.5a.5.5 0 0 1 1 0"/>
                    </svg>
                    Commit & Push
                </button>

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="alert alert-info mt-2">@statusMessage</div>
                }
            </div>
        }


@code {
    [Inject] GitService Git { get; set; }

    private List<Project> projects;
    private Project editingProject;
    private bool isNew = false;

    private string commitMessage = "Updated project list";
    private string statusMessage;

    protected override async Task OnInitializedAsync()
    {
        projects = await Repo.LoadProjectsAsync();
    }

    void NewProject()
    {
        editingProject = new Project(); // ID automatikusan generálódik a Repo-ban
        isNew = true;
    }

    void EditProject(Project project)
    {
        // Klónozzuk, hogy ne írja felül azonnal a listát
        editingProject = new Project
        {
            Id = project.Id,
            Title = project.Title,
            Description = project.Description,
            Link = project.Link,
            Image = project.Image
        };
        isNew = false;
    }

    async Task SaveProject()
    {
        if (projects == null || editingProject == null) return;

        if (isNew)
        {
            await Repo.AddProjectAsync(editingProject);
        }
        else
        {
            await Repo.UpdateProjectAsync(editingProject);
        }

        // Frissítjük a listát a legújabb állapotra
        projects = await Repo.LoadProjectsAsync();
        editingProject = null;
    }

    async Task DeleteProject(string id)
    {
        if (projects == null) return;

        await Repo.DeleteProjectAsync(id);
        projects = await Repo.LoadProjectsAsync();
    }

    void CancelEdit()
    {
        editingProject = null;
    }

    async Task CommitAndPush()
    {
        try
        {
            statusMessage = "Running git commands...";
            StateHasChanged(); // frissíti az UI-t

            await Task.Run(() => Git.CommitAndPush(commitMessage));

            commitMessage = "";
            statusMessage = "Commit & Push successful!";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error while trying to commit/push: {ex.Message}";
        }
    }
}
